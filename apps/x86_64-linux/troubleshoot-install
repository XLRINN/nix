#!/usr/bin/env bash
set -eu

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Emojis
ERROR="❌"
SUCCESS="✅"
WARNING="⚠️"
INFO="ℹ️"

_print() {
  echo -e "$1"
}

_print "${BLUE}${INFO} NixOS Installation Troubleshooting${NC}"
_print "${YELLOW}${WARNING} This script will help diagnose partition mounting issues${NC}"

# Check if we're in the installer environment
if [ ! -e /etc/NIXOS ]; then
  _print "${RED}${ERROR} Not running in the NixOS installer environment.${NC}"
  _print "${YELLOW}Please run this from the NixOS installer.${NC}"
  exit 1
fi

_print "${GREEN}${SUCCESS} Running in NixOS installer environment${NC}"

# Check available disks
_print "${BLUE}${INFO} Available disks:${NC}"
lsblk -f

# Check if /mnt is mounted
if mountpoint -q /mnt; then
  _print "${GREEN}${SUCCESS} /mnt is mounted${NC}"
  _print "${BLUE}${INFO} Mounted filesystems:${NC}"
  mount | grep /mnt
else
  _print "${RED}${ERROR} /mnt is not mounted${NC}"
  _print "${YELLOW}${WARNING} You need to mount the root filesystem first${NC}"
fi

# Check for partition labels
_print "${BLUE}${INFO} Checking for partition labels:${NC}"
if command -v blkid >/dev/null 2>&1; then
  blkid | grep -E "(disk-main-root|ESP)" || _print "${YELLOW}${WARNING} No expected partition labels found${NC}"
else
  _print "${YELLOW}${WARNING} blkid not available${NC}"
fi

# Check for device paths
_print "${BLUE}${INFO} Checking for device paths:${NC}"
ls -la /dev/disk/by-partlabel/ 2>/dev/null || _print "${YELLOW}${WARNING} No partition labels directory found${NC}"
ls -la /dev/disk/by-label/ 2>/dev/null || _print "${YELLOW}${WARNING} No label directory found${NC}"

# Check if disko is available
if command -v disko >/dev/null 2>&1; then
  _print "${GREEN}${SUCCESS} Disko is available${NC}"
else
  _print "${YELLOW}${WARNING} Disko not available, using nix run${NC}"
fi

# Provide fix suggestions
_print "${BLUE}${INFO} Suggested fixes:${NC}"
_print "${YELLOW}1. If partitions exist but labels are wrong:${NC}"
_print "${YELLOW}   - Recreate partitions with correct labels${NC}"
_print "${YELLOW}2. If partitions don't exist:${NC}"
_print "${YELLOW}   - Run the disk setup process again${NC}"
_print "${YELLOW}3. If labels exist but mounting fails:${NC}"
_print "${YELLOW}   - Check filesystem integrity${NC}"

# Check if we can access the configuration
if [ -f /mnt/etc/nixos/flake.nix ]; then
  _print "${GREEN}${SUCCESS} Configuration found at /mnt/etc/nixos${NC}"
else
  _print "${RED}${ERROR} Configuration not found at /mnt/etc/nixos${NC}"
  _print "${YELLOW}${WARNING} Make sure you've copied the configuration files${NC}"
fi

_print "${BLUE}${INFO} Troubleshooting complete${NC}" 