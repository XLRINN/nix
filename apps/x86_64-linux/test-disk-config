#!/usr/bin/env bash
set -eu

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Emojis
ERROR="❌"
SUCCESS="✅"
WARNING="⚠️"
INFO="ℹ️"

_print() {
  echo -e "$1"
}

_print "${BLUE}${INFO} Testing Disk Configuration${NC}"

# Check if we're in the installer environment
if [ ! -e /etc/NIXOS ]; then
  _print "${RED}${ERROR} Not running in the NixOS installer environment.${NC}"
  exit 1
fi

# Check if the disk config file exists
if [ ! -f "./modules/server/disk-config.nix" ]; then
  _print "${RED}${ERROR} Disk configuration file not found!${NC}"
  exit 1
fi

_print "${GREEN}${SUCCESS} Disk configuration file found${NC}"

# Test the nix syntax
_print "${BLUE}${INFO} Testing Nix syntax...${NC}"
if nix eval --file "./modules/server/disk-config.nix" --show-trace; then
  _print "${GREEN}${SUCCESS} Nix syntax is valid${NC}"
else
  _print "${RED}${ERROR} Nix syntax error in disk configuration${NC}"
  exit 1
fi

# Test disko evaluation
_print "${BLUE}${INFO} Testing Disko evaluation...${NC}"
if nix run --extra-experimental-features nix-command --extra-experimental-features flakes \
  github:nix-community/disko -- --mode eval "./modules/server/disk-config.nix"; then
  _print "${GREEN}${SUCCESS} Disko configuration is valid${NC}"
else
  _print "${RED}${ERROR} Disko configuration error${NC}"
  exit 1
fi

_print "${GREEN}${SUCCESS} Disk configuration test passed!${NC}" 