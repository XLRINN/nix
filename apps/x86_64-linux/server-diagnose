#!/usr/bin/env bash
set -eu

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Emojis
ERROR="❌"
SUCCESS="✅"
WARNING="⚠️"
INFO="ℹ️"

_print() {
  echo -e "$1"
}

_print "${BLUE}${INFO} Server Installation Diagnostic Tool${NC}"
_print "${YELLOW}${WARNING} This will help diagnose server installation issues${NC}"

# Check if we're in the installer environment
if [ ! -e /etc/NIXOS ]; then
  _print "${RED}${ERROR} Not running in the NixOS installer environment.${NC}"
  _print "${YELLOW}Please run this from the NixOS installer.${NC}"
  exit 1
fi

_print "${GREEN}${SUCCESS} Running in NixOS installer environment${NC}"

# Check EFI vs BIOS boot mode
_print "${BLUE}${INFO} Checking boot mode:${NC}"
if [ -d /sys/firmware/efi ]; then
  _print "${RED}${ERROR} System is booted in EFI mode${NC}"
  _print "${YELLOW}${WARNING} Your server configuration is set up for BIOS boot${NC}"
  _print "${YELLOW}${WARNING} You need to boot in BIOS/Legacy mode instead${NC}"
  _print "${BLUE}${INFO} Solutions:${NC}"
  _print "${YELLOW}1. Reboot and enter BIOS/UEFI settings${NC}"
  _print "${YELLOW}2. Change boot mode from 'UEFI' to 'Legacy' or 'CSM'${NC}"
  _print "${YELLOW}3. Disable 'Secure Boot' if enabled${NC}"
  _print "${YELLOW}4. Save and exit BIOS, then boot from USB again${NC}"
else
  _print "${GREEN}${SUCCESS} System is booted in BIOS/Legacy mode${NC}"
  _print "${GREEN}${SUCCESS} This is correct for server installation${NC}"
fi

# Check available disks
_print "${BLUE}${INFO} Available disks:${NC}"
lsblk -f

# Check for the specific partition label that's causing issues
_print "${BLUE}${INFO} Checking for 'disk-main-root' partition label:${NC}"
if blkid | grep -q "disk-main-root"; then
  _print "${GREEN}${SUCCESS} Found partition with label 'disk-main-root'${NC}"
  blkid | grep "disk-main-root"
else
  _print "${RED}${ERROR} No partition with label 'disk-main-root' found${NC}"
  _print "${YELLOW}${WARNING} This is likely the cause of the mounting issue${NC}"
fi

# Check for any partition labels
_print "${BLUE}${INFO} All partition labels:${NC}"
blkid | grep -o 'LABEL="[^"]*"' || _print "${YELLOW}${WARNING} No partition labels found${NC}"

# Check device paths
_print "${BLUE}${INFO} Device paths:${NC}"
ls -la /dev/disk/by-partlabel/ 2>/dev/null || _print "${YELLOW}${WARNING} No partition labels directory found${NC}"
ls -la /dev/disk/by-label/ 2>/dev/null || _print "${YELLOW}${WARNING} No label directory found${NC}"

# Check if /mnt is mounted
if mountpoint -q /mnt; then
  _print "${GREEN}${SUCCESS} /mnt is mounted${NC}"
  _print "${BLUE}${INFO} Mounted filesystems:${NC}"
  mount | grep /mnt
else
  _print "${RED}${ERROR} /mnt is not mounted${NC}"
  _print "${YELLOW}${WARNING} You need to mount the root filesystem first${NC}"
fi

# Check server configuration
_print "${BLUE}${INFO} Checking server configuration:${NC}"
if [ -f /mnt/etc/nixos/flake.nix ]; then
  _print "${GREEN}${SUCCESS} Server configuration found${NC}"
  
  # Check if it's using the server disk config
  if grep -q "server/disk-config.nix" /mnt/etc/nixos/flake.nix; then
    _print "${GREEN}${SUCCESS} Using server disk configuration${NC}"
  else
    _print "${YELLOW}${WARNING} Not using server disk configuration${NC}"
  fi
else
  _print "${RED}${ERROR} No configuration found at /mnt/etc/nixos${NC}"
fi

# Provide specific fix for server installation
_print "${BLUE}${INFO} Server-specific fixes:${NC}"
_print "${YELLOW}1. If 'disk-main-root' label is missing:${NC}"
_print "${YELLOW}   - Recreate partitions using the server disk config${NC}"
_print "${YELLOW}2. If partitions exist but mounting fails:${NC}"
_print "${YELLOW}   - Check if the server disk config is being used${NC}"
_print "${YELLOW}3. If configuration is wrong:${NC}"
_print "${YELLOW}   - Ensure you're using the server template, not desktop${NC}"
_print "${YELLOW}4. If booting in EFI mode:${NC}"
_print "${YELLOW}   - Reboot and change BIOS to Legacy/CSM mode${NC}"

_print "${BLUE}${INFO} To fix the partition issue, run:${NC}"
_print "${YELLOW}./apps/x86_64-linux/fix-partitions${NC}"

_print "${BLUE}${INFO} To fix EFI boot issue:${NC}"
_print "${YELLOW}1. Reboot and enter BIOS (usually F2, F10, or Del)${NC}"
_print "${YELLOW}2. Find 'Boot Mode' or 'UEFI/BIOS Boot Mode'${NC}"
_print "${YELLOW}3. Change from 'UEFI' to 'Legacy' or 'CSM'${NC}"
_print "${YELLOW}4. Disable 'Secure Boot' if present${NC}"
_print "${YELLOW}5. Save and exit, then boot from USB again${NC}"

_print "${BLUE}${INFO} Diagnostic complete${NC}" 