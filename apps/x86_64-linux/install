#!/usr/bin/env bash

VERSION=1.0

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}Starting NixOS installation...${NC}"

# Detect system architecture
SYSTEM=$(uname -m)
case "$SYSTEM" in
  x86_64)
    FLAKE_TARGET="x86_64-linux"
    APP_DIR="x86_64-linux"
    ;;
  aarch64)
    FLAKE_TARGET="aarch64-linux"
    APP_DIR="aarch64-linux"
    ;;
  *)
    echo -e "${RED}Unsupported architecture: $SYSTEM${NC}"
    exit 1
    ;;
esac

echo -e "${YELLOW}Detected architecture: $SYSTEM${NC}"
echo -e "${YELLOW}Using flake target: $FLAKE_TARGET${NC}"

# Check if we're in the NixOS installer environment
if [ ! -e /etc/NIXOS ]; then
    echo -e "${RED}This script must be run from the NixOS installer environment.${NC}"
    exit 1
fi

# Run the apply script first to configure the system
echo -e "${YELLOW}Running apply script to configure installation...${NC}"
./apps/$APP_DIR/apply

if [ $? -eq 0 ]; then
    echo -e "${GREEN}Configuration applied successfully.${NC}"
    
    # Run disko to format and mount the disk
    echo -e "${YELLOW}Formatting and mounting disk...${NC}"
    nix run --extra-experimental-features nix-command --extra-experimental-features flakes \
      github:nix-community/disko -- --mode zap_create_mount ./modules/nixos/disk-config.nix
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Disk formatted and mounted successfully.${NC}"
        
        # Copy configuration to /mnt
        echo -e "${YELLOW}Copying configuration to /mnt...${NC}"
        mkdir -p /mnt/etc/nixos
        cp -r * /mnt/etc/nixos/
        
        # Install NixOS
        echo -e "${YELLOW}Installing NixOS...${NC}"
        nixos-install --flake .#$FLAKE_TARGET --option download-buffer-size 8388608
        
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}Installation completed successfully!${NC}"
            echo -e "${YELLOW}You can now reboot your system.${NC}"
        else
            echo -e "${RED}NixOS installation failed. Please check the error messages above.${NC}"
            exit 1
        fi
    else
        echo -e "${RED}Disk formatting failed. Please check the error messages above.${NC}"
        exit 1
    fi
else
    echo -e "${RED}Apply script failed. Please check the error messages above.${NC}"
    exit 1
fi 