#!/usr/bin/env bash

VERSION=1.0

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}Starting NixOS installation...${NC}"

# Detect system architecture
SYSTEM=$(uname -m)
case "$SYSTEM" in
  x86_64)
    FLAKE_TARGET="x86_64-linux"
    APP_DIR="x86_64-linux"
    ;;
  aarch64)
    FLAKE_TARGET="aarch64-linux"
    APP_DIR="aarch64-linux"
    ;;
  *)
    echo -e "${RED}Unsupported architecture: $SYSTEM${NC}"
    exit 1
    ;;
esac

echo -e "${YELLOW}Detected architecture: $SYSTEM${NC}"
echo -e "${YELLOW}Using flake target: $FLAKE_TARGET${NC}"

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
APPS_DIR="$(dirname "$SCRIPT_DIR")"
FLAKE_DIR="$(dirname "$APPS_DIR")"

# Change to the flake directory first
cd "$FLAKE_DIR"
echo -e "${YELLOW}Changed to flake directory: $FLAKE_DIR${NC}"

# Run the apply script first to configure the system
echo -e "${YELLOW}Running apply script to configure installation...${NC}"
echo -e "${YELLOW}Script directory: $SCRIPT_DIR${NC}"
echo -e "${YELLOW}Apps directory: $APPS_DIR${NC}"
echo -e "${YELLOW}Looking for: $APPS_DIR/$APP_DIR/apply${NC}"

if [ -f "$APPS_DIR/$APP_DIR/apply" ]; then
    "$APPS_DIR/$APP_DIR/apply"
else
    echo -e "${RED}Could not find apply script at $APPS_DIR/$APP_DIR/apply${NC}"
    echo -e "${YELLOW}Available files in $APPS_DIR/$APP_DIR/:${NC}"
    ls -la "$APPS_DIR/$APP_DIR/" 2>/dev/null || echo "Directory not found"
    exit 1
fi

if [ $? -eq 0 ]; then
    echo -e "${GREEN}Configuration applied successfully.${NC}"
    
    # Run the build-switch script to install
    echo -e "${YELLOW}Building and switching to new configuration...${NC}"
    "$APPS_DIR/$APP_DIR/build-switch"
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}Installation completed successfully!${NC}"
        echo -e "${YELLOW}You can now reboot your system.${NC}"
    else
        echo -e "${RED}Build-switch failed. Please check the error messages above.${NC}"
        exit 1
    fi
else
    echo -e "${RED}Apply script failed. Please check the error messages above.${NC}"
    exit 1
fi 