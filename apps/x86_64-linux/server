#!/usr/bin/env bash
set -eu

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color



check_installer() {
  if [ -e /etc/NIXOS ]; then
    echo -e "\e[1;32mRunning in the NixOS installer environment.\e[0m"
    
    # Set password for nixos user
    echo "nixos:nixos" | chpasswd
    
    # Start SSH service
    systemctl start ssh
    systemctl enable ssh
    
    # Show IP address for SSH connection
    IP=$(ip route get 1.1.1.1 | awk '{print $7}')
    echo -e "\e[1;32mSSH enabled! Connect with: ssh nixos@$IP\e[0m"
    echo -e "\e[1;32mPassword: nixos\e[0m"
  else
    echo -e "\e[1;31mNot running in the NixOS installer environment.\e[0m"
    exit 1
  fi
}

cleanup() {
  rm -rf nixos-config-main.zip nixos-config-main nixos-config
}

download_config() {
  curl -LJ0 https://github.com/xlrinn/nix/archive/server.zip -o nixos-config-main.zip
  unzip nixos-config-main.zip
  mv nix-server nixos-config
  cd nixos-config
}

run_apply() {
  ./apps/x86_64-linux/apply
  if [ ! -f /tmp/username.txt ]; then
    echo -e "\e[1;31mError: /tmp/username.txt does not exist.\e[0m"
    exit 1
  fi
  export USERNAME=$(cat /tmp/username.txt)
  echo -e "${GREEN}✓ Configuration complete${NC}"
}

run_disko() {
  # Ask user for BIOS or UEFI
  echo -e "${CYAN}${QUESTION} Choose boot type:${NC}"
  echo -e "${YELLOW}1) BIOS (Legacy)${NC}"
  echo -e "${YELLOW}2) UEFI${NC}"
  read -p "Enter choice (1 or 2): " boot_choice
  
  case $boot_choice in
    1)
      echo -e "${GREEN}Using BIOS disk configuration${NC}"
      DISK_CONFIG="./modules/server/disk-config.nix"
      ;;
    2)
      echo -e "${GREEN}Using UEFI disk configuration${NC}"
      DISK_CONFIG="./modules/nixos/disk-config.nix"
      ;;
    *)
      echo -e "${RED}Invalid choice. Using BIOS configuration.${NC}"
      DISK_CONFIG="./modules/server/disk-config.nix"
      ;;
  esac
  
  nix run --extra-experimental-features nix-command --extra-experimental-features flakes \
    --option cores 0 --option max-jobs auto \
    github:nix-community/disko -- --mode zap_create_mount $DISK_CONFIG
  echo -e "${GREEN}✓ Disk formatted and mounted${NC}"
}

setup_files() {
  mkdir -p /mnt/etc/nixos
  cp -r * /mnt/etc/nixos
  cd /mnt/etc/nixos
  echo -e "${GREEN}✓ Files copied to system${NC}"
}

install_nixos() {
  ARCH=$(uname -m)

  case "$ARCH" in
    x86_64)
      FLAKE_TARGET="x86_64-linux-server"
      ;;
    aarch64)
      FLAKE_TARGET="aarch64-linux-server"
      ;;
    *)
      echo -e "${RED}Unsupported architecture: $ARCH${NC}"
      exit 1
      ;;
  esac

  nixos-install --flake .#$FLAKE_TARGET --option download-buffer-size 134217728 --option cores 0 --option max-jobs auto
  chmod -R 775 /mnt/etc/nixos
  
  # Copy config to user's home directory (like dustinlyons does)
  export USERNAME=$(cat /tmp/username.txt)
  mkdir -p /mnt/home/$USERNAME/.local/share/src
  cp -r /mnt/etc/nixos /mnt/home/$USERNAME/.local/share/src/
  
  # Set up git remote for the user's config
  chroot /mnt bash -c "cd /home/$USERNAME/.local/share/src/nixos && git init && git remote add origin https://github.com/xlrinn/nix.git"
  
  # Fix ownership after user is created
  chroot /mnt bash -c "chown -R $USERNAME:users /home/$USERNAME/.local/share/src/nixos" || echo "Note: Ownership will be set correctly after first boot"
  
  echo -e "${GREEN}✓ NixOS Server installed successfully${NC}"
  echo -e "${GREEN}✓ Configuration copied to /home/$USERNAME/.local/share/src/nixos${NC}"
  echo -e "${GREEN}✓ Git remote configured${NC}"
}

prompt_reboot() {
  read -p "Do you want to reboot now? (y/yes) " choice
  case "$choice" in
  y|Y|yes|YES ) echo -e "\e[1;32mRebooting...\e[0m" && reboot;;
  * ) echo -e "\e[1;33mReboot skipped.\e[0m";;
  esac
}

cleanup
check_installer
download_config
run_apply
run_disko
setup_files
install_nixos
cleanup
prompt_reboot
