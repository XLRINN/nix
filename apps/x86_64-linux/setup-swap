#!/usr/bin/env bash

# Setup swap file for hibernation
# This script should be run after the system is installed and booted

set -e

echo "Setting up swap file for hibernation..."

# Get RAM size from the file created during installation
if [[ -f /tmp/ram_size_mb.txt ]]; then
  RAM_SIZE_MB=$(cat /tmp/ram_size_mb.txt)
  echo "Using RAM size from installation: ${RAM_SIZE_MB}MB"
else
  # Fallback: detect RAM size
  RAM_SIZE_KB=$(grep MemTotal /proc/meminfo | awk '{print $2}')
  RAM_SIZE_MB=$((RAM_SIZE_KB / 1024))
  echo "Detected RAM size: ${RAM_SIZE_MB}MB"
fi

# Create swap directory if it doesn't exist
sudo mkdir -p /swap

# Create swap file with RAM size
echo "Creating swap file with size ${RAM_SIZE_MB}MB..."
sudo fallocate -l ${RAM_SIZE_MB}M /swap/swapfile

# Set correct permissions
sudo chmod 600 /swap/swapfile

# Make it a swap file
sudo mkswap /swap/swapfile

# Enable the swap file
sudo swapon /swap/swapfile

# Add to fstab for persistence
echo "/swap/swapfile none swap sw 0 0" | sudo tee -a /etc/fstab

# Get the swap file offset for hibernation
SWAP_OFFSET=$(sudo filefrag -v /swap/swapfile | awk '{if($1=="0:"){print $4}}' | sed 's/\.//')

echo "Swap file created successfully!"
echo "Swap file size: ${RAM_SIZE_MB}MB"
echo "Swap file offset: ${SWAP_OFFSET}"

# Update kernel parameters for hibernation
echo "Updating kernel parameters for hibernation..."

# Create a backup of the current kernel parameters
sudo cp /etc/nixos/hardware-configuration.nix /etc/nixos/hardware-configuration.nix.backup

# Update the resume device and offset
sudo sed -i "s|resumeDevice = \".*\";|resumeDevice = \"/swap/swapfile\";|g" /etc/nixos/hardware-configuration.nix
sudo sed -i "s|resume_offset = [0-9]*;|resume_offset = ${SWAP_OFFSET};|g" /etc/nixos/hardware-configuration.nix

echo "Kernel parameters updated for hibernation."
echo "You can now use hibernation with: sudo systemctl hibernate"
echo "Or suspend to RAM with: sudo systemctl suspend" 