#!/usr/bin/env bash

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Emojis
ROCKET="🚀"
GEAR="⚙️"
DISK="💾"
COMPUTER="💻"
CHECK="✅"
WARNING="⚠️"
ERROR="❌"
INFO="ℹ️"
QUESTION="❓"
PARTY="🎉"

# Determine the operating system
export OS=$(uname)

# Primary network interface
if [[ "$OS" != "Darwin" ]]; then
  export PRIMARY_IFACE=$(ip -o -4 route show to default | awk '{print $5}')
  echo -e "${GREEN}${INFO} Found primary network interface: $PRIMARY_IFACE${NC}"
fi

# Custom print function
_print() {
  echo -e "$1"
}

# Custom prompt function
_prompt() {
  local message="$1"
  local variable="$2"

  _print "$message"
  read -r $variable
}

# Set default values
export USERNAME="david"
export GIT_EMAIL="xlrin.morgan@gmail.com"
export GIT_NAME="david"

# Clear screen and show ASCII art
clear
echo
echo "    ███╗   ██╗██╗   ██╗██╗  ██╗"
echo "    ████╗  ██║╚██╗ ██╔╝╚██╗██╔╝"
echo "    ██╔██╗ ██║ ╚████╔╝  ╚███╔╝ "
echo "    ██║╚██╗██║  ╚██╔╝   ██╔██╗ "
echo "    ██║ ╚████║   ██║   ██╔╝ ██╗"
echo "    ╚═╝  ╚═══╝   ╚═╝   ╚═╝  ╚═╝"
echo "                @XLRINN"
echo
echo "═══════════════════════════════════════════════════════════"
echo

# Enhanced drive selection
select_drive() {
  _print "\n${YELLOW}=== Available Drives ===${NC}"
  _print "Scanning for available drives..."
  
  # Get list of drives (excluding loop devices and partitions)
  drives=($(lsblk -d -n -o NAME,SIZE,MODEL | grep -E '^(sd[a-z]|nvme[0-9]+n[0-9]+|hd[a-z])' | awk '{print $1}'))
  
  # Try to identify the live USB drive to exclude it
  live_usb=""
  if [ -f /proc/cmdline ]; then
    cmdline=$(cat /proc/cmdline)
    if echo "$cmdline" | grep -q "boot=live"; then
      # This is a live USB, try to identify it
      live_usb=$(lsblk -d -n -o NAME,MOUNTPOINT | grep "/run/archiso/bootmnt\|/run/archiso/airootfs\|/run/archiso/iso" | head -1 | awk '{print $1}')
    fi
  fi
  
  if [ ${#drives[@]} -eq 0 ]; then
    _print "${RED}No suitable drives found!${NC}"
    exit 1
  fi
  
  # Warn about live USB if detected
  if [ -n "$live_usb" ]; then
    _print "\n${YELLOW}${WARNING}  Live USB detected: /dev/$live_usb${NC}"
    _print "${YELLOW}Make sure you don't select this drive for installation!${NC}"
  fi
  
  _print "\n${GREEN}Available drives:${NC}"
  for i in "${!drives[@]}"; do
    drive_info=$(lsblk -d -n -o NAME,SIZE,MODEL /dev/${drives[$i]} | head -1)
    drive_size=$(echo "$drive_info" | awk '{print $2}')
    drive_model=$(echo "$drive_info" | awk '{for(i=3;i<=NF;i++) printf "%s ", $i; print ""}' | sed 's/ *$//')
    _print "  ${YELLOW}[$((i+1))]${NC} /dev/${drives[$i]} - ${GREEN}Size: $drive_size${NC} - ${CYAN}Model: $drive_model${NC}"
  done
  
  _print "\n${YELLOW}${WARNING} WARNING: This will completely erase the selected drive!${NC}"
  _print "${RED}Make sure you have backed up any important data!${NC}"
  
  # Show additional drive details
  _print "\n${CYAN}Detailed drive information:${NC}"
  for i in "${!drives[@]}"; do
    _print "\n${YELLOW}Drive [$((i+1))] - /dev/${drives[$i]}:${NC}"
    lsblk -d -o NAME,SIZE,MODEL,SERIAL,MOUNTPOINT /dev/${drives[$i]}
    echo ""
  done
  
  while true; do
    _prompt "${YELLOW}${QUESTION} Select drive number (1-${#drives[@]}): ${NC}" choice
    if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#drives[@]}" ]; then
      selected_drive="/dev/${drives[$((choice-1))]}"
      _print "\n${GREEN}Selected drive: $selected_drive${NC}"
      _prompt "${YELLOW}Are you sure you want to install NixOS on $selected_drive? (yes/no): ${NC}" confirm
      if [[ "$confirm" == "yes" ]]; then
        # Update the disk-config.nix file with the selected drive
        sed -i "s|device = \"/dev/sda\";|device = \"$selected_drive\";|g" ./modules/nixos/disk-config.nix
        _print "\n${GREEN}${CHECK} Drive configuration updated!${NC}"
        _print "${GREEN}${CHECK} NixOS will be installed on: $selected_drive${NC}"
        _print "${YELLOW}Proceeding with installation...${NC}"
        export BOOT_DISK=$(basename $selected_drive)
        break
      else
        _print "${YELLOW}Drive selection cancelled. Please try again.${NC}"
      fi
    else
      _print "${RED}Invalid selection. Please enter a number between 1 and ${#drives[@]}.${NC}"
    fi
  done
}

# Set hostname and find primary disk if this is NixOS
if [[ "$OS" != "Darwin" ]]; then
  _print "${CYAN}${COMPUTER} Please enter a hostname for your system:${NC}"
  _prompt "${YELLOW}${QUESTION} Hostname: ${NC}" HOST_NAME
  _print "${GREEN}${CHECK} Hostname set to: $HOST_NAME${NC}"
  
  select_drive
fi

# Show installation starting
echo
_print "${CYAN}${INFO} Starting installation...${NC}"

# Function to replace tokens in each file
replace_tokens() {
  local file="$1"
  if [[ $(basename $1) != "apply" ]]; then
    if [[ "$OS" == "Darwin" ]]; then
      # macOS
      LC_ALL=C LANG=C sed -i '' -e "s/%USER%/$USERNAME/g" "$file"
      LC_ALL=C LANG=C sed -i '' -e "s/%EMAIL%/$GIT_EMAIL/g" "$file"
      LC_ALL=C LANG=C sed -i '' -e "s/%NAME%/$GIT_NAME/g" "$file"
    else
      # Linux or other
      sed -i -e "s/%USER%/$USERNAME/g" "$file"
      sed -i -e "s/%EMAIL%/$GIT_EMAIL/g" "$file"
      sed -i -e "s/%NAME%/$GIT_NAME/g" "$file"
      sed -i -e "s/%INTERFACE%/$PRIMARY_IFACE/g" "$file"
      sed -i -e "s/%DISK%/$BOOT_DISK/g" "$file"
      sed -i -e "s/%HOST%/$HOST_NAME/g" "$file"
    fi
  fi
}

# Apply configuration
_print "${BLUE}${GEAR} Applying configuration...${NC}"
export -f replace_tokens
find . -type f -exec bash -c 'replace_tokens "$0"' {} \;

echo "$USERNAME" > /tmp/username.txt
_print "${GREEN}${PARTY} Ready!${NC}"
