#!/usr/bin/env bash

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Emojis
ROCKET="🚀"
GEAR="⚙️"
DISK="💾"
COMPUTER="💻"
CHECK="✅"
WARNING="⚠️"
ERROR="❌"
INFO="ℹ️"
QUESTION="❓"
PARTY="🎉"

# Determine the operating system
export OS=$(uname)

# Primary network interface
if [[ "$OS" != "Darwin" ]]; then
  export PRIMARY_IFACE=$(ip -o -4 route show to default | awk '{print $5}')
  echo -e "${GREEN}${INFO} Found primary network interface: $PRIMARY_IFACE${NC}"
fi

# Custom print function
_print() {
  echo -e "$1"
}

# Custom prompt function
_prompt() {
  local message="$1"
  local variable="$2"

  _print "$message"
  read -r $variable
}

# Set default values
export USERNAME="david"
export GIT_EMAIL="xlrin.morgan@gmail.com"
export GIT_NAME="david"

# Clear screen and show ASCII art
clear
echo
echo "    ██╗  ██╗██╗     ██████╗██╗███╗   ██╗"
echo "    ╚██╗██╔╝██║     ██╔══██╗██╔══██╗██║████╗  ██║"
echo "     ╚███╔╝ ██║     ██████╔╝██████╔╝██║██╔██╗ ██║"
echo "     ██╔██╗ ██║     ██╔══██╗██╔══██╗██║██║╚██╗██║"
echo "    ██╔╝ ██╗███████╗██║  ██║██║  ██║██║██║ ╚████║"
echo "    ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝╚═╝  ╚═══╝"
echo "                    NIX INSTALLER"
echo
echo "═══════════════════════════════════════════════════════════"
echo

# Smart disk detection
smart_disk_detection() {
  local main_disk=""
  local available_disks=""
  
  # Get available disks
  available_disks=$(lsblk -nd --output NAME,SIZE | grep -v loop)
  
  # Check if sda exists and is the main disk
  if echo "$available_disks" | grep -q "^sda"; then
    main_disk="sda"
    _print "${GREEN}${CHECK} Using sda as boot disk${NC}"
  else
    _print "${YELLOW}${WARNING} sda not found. Available disks:${NC}"
    echo "$available_disks"
    _prompt "${YELLOW}${QUESTION} Enter disk name: ${NC}" main_disk
  fi
  
  export BOOT_DISK=$main_disk
  _print "${RED}${WARNING} WARNING: All data on $BOOT_DISK will be erased!${NC}"
}

# Set hostname and find primary disk if this is NixOS
if [[ "$OS" != "Darwin" ]]; then
  _print "${CYAN}${COMPUTER} Please enter a hostname for your system:${NC}"
  _prompt "${YELLOW}${QUESTION} Hostname: ${NC}" HOST_NAME
  _print "${GREEN}${CHECK} Hostname set to: $HOST_NAME${NC}"
  
  smart_disk_detection
fi

# Show installation starting
echo
_print "${CYAN}${INFO} Starting installation...${NC}"

# Function to replace tokens in each file
replace_tokens() {
  local file="$1"
  if [[ $(basename $1) != "apply" ]]; then
    if [[ "$OS" == "Darwin" ]]; then
      # macOS
      LC_ALL=C LANG=C sed -i '' -e "s/%USER%/$USERNAME/g" "$file"
      LC_ALL=C LANG=C sed -i '' -e "s/%EMAIL%/$GIT_EMAIL/g" "$file"
      LC_ALL=C LANG=C sed -i '' -e "s/%NAME%/$GIT_NAME/g" "$file"
    else
      # Linux or other
      sed -i -e "s/%USER%/$USERNAME/g" "$file"
      sed -i -e "s/%EMAIL%/$GIT_EMAIL/g" "$file"
      sed -i -e "s/%NAME%/$GIT_NAME/g" "$file"
      sed -i -e "s/%INTERFACE%/$PRIMARY_IFACE/g" "$file"
      sed -i -e "s/%DISK%/$BOOT_DISK/g" "$file"
      sed -i -e "s/%HOST%/$HOST_NAME/g" "$file"
    fi
  fi
}

# Apply configuration
_print "${BLUE}${GEAR} Applying configuration...${NC}"
export -f replace_tokens
find . -type f -exec bash -c 'replace_tokens "$0"' {} \;

echo "$USERNAME" > /tmp/username.txt
_print "${GREEN}${PARTY} Ready!${NC}"
